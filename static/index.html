<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>UKG Panel Webpage with Chat</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/toastify-js"></script>
    <link
      rel="stylesheet"
      type="text/css"
      href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css"
    />
    <script>
      tailwind.config = {
        theme: {
          extend: {
            colors: {
              ukg: {
                blue: "#0066cc",
                green: "#00a650",
                orange: "#ff6a39",
              },
            },
          },
        },
      };
    </script>
    <style>
      /* Existing styles */
      @keyframes fadeIn {
        from {
          opacity: 0;
        }
        to {
          opacity: 1;
        }
      }
      @keyframes slideIn {
        from {
          transform: translateY(20px);
          opacity: 0;
        }
        to {
          transform: translateY(0);
          opacity: 1;
        }
      }
      .fade-in {
        animation: fadeIn 0.5s ease-in-out;
      }
      .slide-in {
        animation: slideIn 0.5s ease-in-out;
      }
      #app {
        display: flex;
        height: 100vh;
        overflow: hidden;
      }
      #leftPanel {
        width: 50%;
        display: flex;
        flex-direction: column;
      }
      #divider {
        width: 10px;
        cursor: col-resize;
        background-color: #d1d5db;
        transition: background-color 0.3s;
      }
      #divider:hover {
        background-color: #ff6a39;
      }
      #rightPanel {
        flex-grow: 1;
        border: none;
      }

      /* New styles for improved UI */
      .chat-message {
        margin-bottom: 1rem;
        padding: 1rem;
        border-radius: 0.5rem;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
      }
      .user-message {
        border-left: 4px solid #0066cc;
        background-color: #e6f2ff;
      }
      .ai-message {
        border-left: 4px solid #00a650;
        background-color: #e6fff2;
      }
      .system-message {
        border-left: 4px solid #ff6a39;
        background-color: #fff2e6;
      }

      /* Custom scrollbar styles */
      .custom-scrollbar::-webkit-scrollbar {
        width: 8px;
      }
      .custom-scrollbar::-webkit-scrollbar-track {
        background: #f1f1f1;
      }
      .custom-scrollbar::-webkit-scrollbar-thumb {
        background: #888;
        border-radius: 4px;
      }
      .custom-scrollbar::-webkit-scrollbar-thumb:hover {
        background: #555;
      }
    </style>
  </head>
  <body class="bg-gray-100 font-sans">
    <div id="app">
      <!-- Left panel (Chat Interface) -->
      <div id="leftPanel" class="bg-white shadow-lg">
        <div class="bg-ukg-blue p-4">
          <h1 class="text-2xl font-bold text-white">UKG Chat</h1>
        </div>
        <div
          id="chatMessages"
          class="flex-grow p-6 overflow-y-auto custom-scrollbar"
        ></div>
        <div class="p-4 border-t border-gray-200">
          <div class="flex">
            <input
              type="text"
              id="chatInput"
              class="flex-grow px-4 py-2 border border-gray-300 rounded-l-md focus:outline-none focus:ring-2 focus:ring-ukg-blue"
              placeholder="Type your message..."
            />
            <button
              id="sendButton"
              class="bg-ukg-blue text-white px-6 py-2 rounded-r-md hover:bg-ukg-green transition-colors duration-300 focus:outline-none focus:ring-2 focus:ring-ukg-orange"
            >
              Send
            </button>
          </div>
        </div>
      </div>

      <!-- Resizable divider -->
      <div id="divider"></div>

      <!-- Right panel -->
      <iframe
        id="rightPanel"
        class="flex-grow border-none bg-white shadow-lg"
        src="about:blank"
      ></iframe>
    </div>

    <script type="module">
      let socket;
      let reconnectAttempts = 0;
      const MAX_RECONNECT_ATTEMPTS = 5;

      // Function to connect to WebSocket
      const connectWebSocket = () => {
        console.log("Attempting to connect to WebSocket");
        socket = new WebSocket("ws://localhost:8080/ws");

        socket.onopen = () => {
          console.log("WebSocket connection established");
          showToast("Connected to the server!", "success");
          addChatMessage("System", "Connected to the server!");
          reconnectAttempts = 0;
        };

        socket.onmessage = (event) => {
          console.log("Received message from server:", event.data);
          addChatMessage("AI", event.data);
        };

        socket.onclose = (event) => {
          const message = event.wasClean
            ? `WebSocket connection closed cleanly, code=${event.code}, reason=${event.reason}`
            : "WebSocket connection died";
          console.log(message);

          if (reconnectAttempts < MAX_RECONNECT_ATTEMPTS) {
            showToast(
              "Disconnected from server. Attempting to reconnect...",
              "warning"
            );
            addChatMessage(
              "System",
              "Disconnected from server. Attempting to reconnect..."
            );
            setTimeout(connectWebSocket, 5000); // Try to reconnect after 5 seconds
            reconnectAttempts++;
          } else {
            showToast(
              "Failed to reconnect after multiple attempts. Please refresh the page.",
              "error"
            );
            addChatMessage(
              "System",
              "Failed to reconnect after multiple attempts. Please refresh the page."
            );
          }
        };

        socket.onerror = (error) => {
          console.log(`WebSocket error: ${error.message}`);
          showToast(
            "Error connecting to server. Please try again later.",
            "error"
          );
        };
      };

      // Function to send a message
      const sendMessage = () => {
        const chatInput = document.getElementById("chatInput");
        const message = chatInput.value.trim();
        if (message && socket.readyState === WebSocket.OPEN) {
          console.log("Sending message:", message);
          socket.send(message);
          addChatMessage("You", message);
          chatInput.value = "";
        } else if (socket.readyState !== WebSocket.OPEN) {
          showToast("Cannot send message. Connection is not open.", "error");
        } else {
          showToast("Please enter a message before sending.", "warning");
        }
      };

      // Function to add a chat message
      const addChatMessage = (sender, message) => {
        console.log("Adding chat message:", message);

        const chatMessages = document.getElementById("chatMessages");
        const messageElement = document.createElement("div");
        messageElement.className = `chat-message slide-in ${
          sender === "You"
            ? "user-message"
            : sender === "AI"
            ? "ai-message"
            : "system-message"
        }`;

        // Extract HTML and JavaScript content from the message
        const htmlContent = extractContentFromMarkdown(message, "html");
        const jsContent = extractContentFromMarkdown(message, "javascript");

        // Remove the extracted content from the original message
        let cleanMessage = message;
        if (htmlContent) {
          cleanMessage = cleanMessage.replace(
            htmlContent,
            "[HTML Content Removed]"
          );
        }
        if (jsContent) {
          cleanMessage = cleanMessage.replace(
            jsContent,
            "[JavaScript Content Removed]"
          );
        }

        // Use marked.js to parse the cleaned message
        messageElement.innerHTML = `<strong>${sender}:</strong> ${marked.parse(
          cleanMessage
        )}`;

        chatMessages.appendChild(messageElement);
        chatMessages.scrollTop = chatMessages.scrollHeight;

        // Display extracted content in the right panel
        if (htmlContent) {
          displayContentInRightPanel(htmlContent, "HTML");
        }
        if (jsContent) {
          displayContentInRightPanel(jsContent, "JavaScript");
        }
      };

      // Function to extract content from markdown
      const extractContentFromMarkdown = (markdown, type) => {
        const patterns = {
          html: /```html([\s\S]*?)```/g,
          javascript: /```javascript([\s\S]*?)```/g,
        };
        if (!patterns[type]) {
          throw new Error(
            'Invalid content type. Choose "html" or "javascript".'
          );
        }
        const matches = [];
        let match;
        while ((match = patterns[type].exec(markdown)) !== null) {
          matches.push(match[1].trim());
        }
        return matches.join("\n");
      };

      // Function to display content in the right panel
      const displayContentInRightPanel = (content, type) => {
        const iframe = document.getElementById("rightPanel");
        iframe.onload = function () {
          const doc = iframe.contentDocument;
          doc.open();
          if (type === "HTML") {
            doc.write(content);
          } else if (type === "JavaScript") {
            doc.write("<script>" + content + "<\/script>");
          }
          doc.close();
        };
        iframe.src = "about:blank";
      };
      // Function to initialize resizable divider
      const initResizableDivider = () => {
        const leftPanel = document.getElementById("leftPanel");
        const divider = document.getElementById("divider");
        const app = document.getElementById("app");

        let isResizing = false;
        let lastX = 0;

        const resize = (e) => {
          if (isResizing) {
            const newX =
              e.clientX || (e.touches && e.touches[0].clientX) || lastX;
            const newWidth = newX - app.offsetLeft;
            const minWidth = 200; // Minimum width for the left panel
            const maxWidth = app.offsetWidth - 200; // Maximum width (leaving 200px for the right panel)

            if (newWidth >= minWidth && newWidth <= maxWidth) {
              leftPanel.style.width = `${newWidth}px`;
              lastX = newX;
            }
          }
        };

        divider.addEventListener("mousedown", (e) => {
          isResizing = true;
          lastX = e.clientX;
          app.style.userSelect = "none";
        });

        divider.addEventListener("touchstart", (e) => {
          isResizing = true;
          lastX = e.touches[0].clientX;
          app.style.userSelect = "none";
          e.preventDefault(); // Prevent scrolling on touch devices
        });

        document.addEventListener("mouseup", () => {
          isResizing = false;
          app.style.userSelect = "";
        });

        document.addEventListener("touchend", () => {
          isResizing = false;
          app.style.userSelect = "";
        });

        document.addEventListener("mousemove", resize);
        document.addEventListener("touchmove", resize);

        // Throttle the resize function for better performance
        const throttledResize = throttle(resize, 10);
        document.addEventListener("mousemove", throttledResize);
        document.addEventListener("touchmove", throttledResize);
      };

      // Throttle function for performance optimization
      function throttle(func, limit) {
        let inThrottle;
        return function () {
          const args = arguments;
          const context = this;
          if (!inThrottle) {
            func.apply(context, args);
            inThrottle = true;
            setTimeout(() => (inThrottle = false), limit);
          }
        };
      }

      // Function to show toast notifications
      const showToast = (message, type = "info") => {
        Toastify({
          text: message,
          duration: 3000,
          gravity: "top",
          position: "right",
          backgroundColor:
            type === "error"
              ? "#ff6b6b"
              : type === "warning"
              ? "#feca57"
              : type === "success"
              ? "#48dbfb"
              : "#54a0ff",
          stopOnFocus: true,
        }).showToast();
      };

      // Initialize the application
      document.addEventListener("DOMContentLoaded", () => {
        connectWebSocket();
        initResizableDivider();

        // Event listeners
        document
          .getElementById("sendButton")
          .addEventListener("click", sendMessage);
        document
          .getElementById("chatInput")
          .addEventListener("keypress", (e) => {
            if (e.key === "Enter") {
              sendMessage();
            }
          });

        // Confirmation before closing the page
        window.addEventListener("beforeunload", (e) => {
          e.preventDefault();
          e.returnValue = "";
        });
      });
    </script>
  </body>
</html>
